name: Promote Dev to Stable

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: promotion-dev
  cancel-in-progress: true

jobs:
  promote:
    name: Maintain Promotion PR
    runs-on: ubuntu-latest
    steps:
      - name: Check for differences between dev and stable
        id: diff
        uses: actions/github-script@v8
        with:
          script: |
            const { data } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: 'stable',
              head: 'dev',
            });
            const hasDiff = data.status !== 'identical' && data.ahead_by > 0;
            core.setOutput('has_diff', hasDiff);

      - name: Exit if no diff
        if: steps.diff.outputs.has_diff != 'true'
        run: echo "No differences to promote."

      - name: Checkout repository
        if: steps.diff.outputs.has_diff == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Build promotion changelog
        if: steps.diff.outputs.has_diff == 'true'
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fromTag: stable
          toTag: dev
          mode: "COMMIT"
          configurationJson: |
            {
              "categories": [
                {
                  "title": "## ‚ú® New Features",
                  "labels": ["feat"]
                },
                {
                  "title": "## üêõ Bug Fixes",
                  "labels": ["fix"]
                },
                {
                  "title": "## üîß Improvements",
                  "labels": ["perf", "refactor"]
                },
                {
                  "title": "## üìö Documentation",
                  "labels": ["docs"]
                },
                {
                  "title": "## ‚ôªÔ∏è Ops",
                  "labels": ["ci", "ops", "build", "test"]
                },
                {
                  "title": "## üßπ Miscellaneous",
                  "labels": ["chore", "style", "deps"]
                },
                {
                  "title": "## ‚è™ Reverts",
                  "labels": ["revert"]
                }
              ],
              "label_extractor": [
                {
                  "pattern": "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test|deps|ops){1}(\\([\\w\\-\\.]+\\))?(!)?: ([\\w ])+([\\s\\S]*)",
                  "on_property": "title",
                  "target": "$1"
                }
              ],
              "template": "#{{CHANGELOG}}\n\n## Full Changelog\n- Compare changes: https://github.com/${{ github.repository }}/compare/stable...dev",
              "empty_template": "## What's Changed\n\nNo user-facing changes were detected.\n\n## Full Changelog\n- Compare changes: https://github.com/${{ github.repository }}/compare/stable...dev",
              "pr_template": "- #{{TITLE}} by @#{{AUTHOR}} in ##{{NUMBER}}"
            }

      - name: Create or update promotion PR
        if: steps.diff.outputs.has_diff == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh_pr_up() {
            gh pr create "$@" || gh pr edit "$@"
          }

          gh_pr_up \
            --title "chore(promotion): promote dev to stable" \
            --body "## ü§ñ Automated Promotion

          ${{ steps.changelog.outputs.changelog }}

          ---
          - Generated by workflow run [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - Trigger: \`${{ github.event_name }}\`
          - Merge strategy expectation: **merge commit** (no squash) to preserve history" \
            --base stable \
            --head dev \
            --label "bot,promotion"
